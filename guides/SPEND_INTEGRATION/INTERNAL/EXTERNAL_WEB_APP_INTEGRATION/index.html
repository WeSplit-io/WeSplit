
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="WeSplit - Split expenses socially, settle instantly with crypto">
      
      
        <meta name="author" content="WeSplit Team">
      
      
        <link rel="canonical" href="https://YOUR_USERNAME.github.io/WeSplit/guides/SPEND_INTEGRATION/INTERNAL/EXTERNAL_WEB_APP_INTEGRATION/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>External Web App Integration - Internal Implementation Guide - WeSplit Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#external-web-app-integration-internal-implementation-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="WeSplit Documentation" class="md-header__button md-logo" aria-label="WeSplit Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WeSplit Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              External Web App Integration - Internal Implementation Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="dark" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/YOUR_USERNAME/WeSplit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    WeSplit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../index.md" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../CORBITS_X402_INTEGRATION_PLAN.md" class="md-tabs__link">
          
  
  
  Corbits Integration

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../AUTH_CONFIG_STATUS/" class="md-tabs__link">
          
  
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../BADGE_SETUP_SUMMARY/" class="md-tabs__link">
          
  
  
  Features

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../QUICK_TEST_GUIDE/" class="md-tabs__link">
          
  
  
  Testing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="WeSplit Documentation" class="md-nav__button md-logo" aria-label="WeSplit Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    WeSplit Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/YOUR_USERNAME/WeSplit" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    WeSplit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Corbits Integration
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Corbits Integration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../CORBITS_X402_INTEGRATION_PLAN.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration Plan
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../AUTH_CONFIG_STATUS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../PHANTOM_INTEGRATION_PLAN/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Phantom Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../BADGE_SETUP_SUMMARY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Badges
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../REFERRAL_SYSTEM_COMPLETE.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Referrals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../QUICK_TEST_GUIDE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Test Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LOCAL_BUILD_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Local Build
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Architecture Overview
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-components" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Components
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-implementation-process" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step-by-Step Implementation Process
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-Step Implementation Process">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-request-reception-security-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Request Reception &amp; Security Validation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 1: Request Reception &amp; Security Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-receive-http-request" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Receive HTTP Request
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-extract-and-validate-api-key" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Extract and Validate API Key
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-rate-limiting-check" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Rate Limiting Check
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-input-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 Input Sanitization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-data-validation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Data Validation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 2: Data Validation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-validate-required-fields" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Validate Required Fields
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-validate-optional-fields-if-provided" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Validate Optional Fields (if provided)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-user-account-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 3: User Account Management
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 3: User Account Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-check-if-user-exists" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Check if User Exists
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-handle-existing-user" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Handle Existing User
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-create-new-user" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Create New User
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-currency-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 4: Currency Conversion
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 4: Currency Conversion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-convert-amount-to-usdc" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Convert Amount to USDC
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-split-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 5: Split Creation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 5: Split Creation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-transform-payment-data-to-split-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 Transform Payment Data to Split Format
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-create-split-document" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Create Split Document
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-store-split-in-firestore" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 Store Split in Firestore
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-return-response" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 Return Response
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-how-users-see-and-interact-with-the-split" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 6: How Users See and Interact with the Split
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 6: How Users See and Interact with the Split">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-split-appears-in-users-split-list" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Split Appears in User's Split List
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-user-opens-split-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 User Opens Split Details
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-user-can-invite-others-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 User Can Invite Others (Optional)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-user-creates-split-wallet-when-ready" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 User Creates Split Wallet (When Ready)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-7-data-storage-and-distribution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 7: Data Storage and Distribution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 7: Data Storage and Distribution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-where-data-is-stored" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Where Data is Stored
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-how-data-is-distributed-to-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 How Data is Distributed to Users
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-data-flow-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Data Flow Summary
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-8-important-implementation-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 8: Important Implementation Notes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 8: Important Implementation Notes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-split-status-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Split Status Flow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-participant-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 Participant Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-metadata-tracking" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 Metadata Tracking
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 6: Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step 6: Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-error-types-and-responses" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Error Types and Responses
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-key-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Key Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Rate Limiting
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#input-sanitization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Input Sanitization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-logging" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring &amp; Logging
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring &amp; Logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-we-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        What We Log
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-we-dont-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        What We Don't Log
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing Scenarios
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-case-1-new-user-with-wallet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Case 1: New User with Wallet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-case-2-new-user-without-wallet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Case 2: New User without Wallet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-case-3-existing-user" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Case 3: Existing User
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-case-4-existing-user-with-new-wallet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Case 4: Existing User with New Wallet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-case-5-invalid-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Case 5: Invalid Data
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-user-flow-after-split-creation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete User Flow After Split Creation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Complete User Flow After Split Creation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-the-user-sees-the-split" class="md-nav__link">
    <span class="md-ellipsis">
      
        How the User Sees the Split
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-storage-locations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Storage Locations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-data-spreads-to-users" class="md-nav__link">
    <span class="md-ellipsis">
      
        How Data Spreads to Users
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment Checklist
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-structures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Structures
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Structures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#incoming-payment-data-format" class="md-nav__link">
    <span class="md-ellipsis">
      
        Incoming Payment Data Format
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processedbilldata-format-internal" class="md-nav__link">
    <span class="md-ellipsis">
      
        ProcessedBillData Format (Internal)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#user-creation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Creation Logic
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split-creation-logic" class="md-nav__link">
    <span class="md-ellipsis">
      
        Split Creation Logic
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#currency-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Currency Conversion
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validation-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-creation-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        User Creation Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split-creation-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Split Creation Errors
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test Scenarios
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="external-web-app-integration-internal-implementation-guide">External Web App Integration - Internal Implementation Guide<a class="headerlink" href="#external-web-app-integration-internal-implementation-guide" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>This document outlines the <strong>internal implementation</strong> on the WeSplit side for integrating with external web applications. This guide is for WeSplit developers to understand the complete flow and implementation details.</p>
<h2 id="architecture-overview">Architecture Overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<h3 id="data-flow">Data Flow<a class="headerlink" href="#data-flow" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>External Web App
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    ↓ (HTTPS POST with API Key)
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>Firebase Function (createSplitFromPayment)
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    ↓ (API Key Validation)
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    ↓ (Rate Limiting Check)
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    ↓ (Input Sanitization)
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    ↓ (Data Validation)
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>User Service (createOrGetUser)
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    ↓ (Check by Email)
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    ↓ (Create/Link Wallet)
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>Split Service (createSplitFromPayment)
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    ↓ (Transform Data)
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    ↓ (Create Split)
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>Firestore Database
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    ↓ (Return Response)
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>External Web App
</code></pre></div>
<h3 id="key-components">Key Components<a class="headerlink" href="#key-components" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Firebase Function</strong> (<code>externalPaymentIntegration.js</code>): Receives and validates incoming data</li>
<li><strong>API Key Validation</strong>: Validates API key from Firestore</li>
<li><strong>Rate Limiting</strong>: Enforces 100 requests per 15 minutes per API key</li>
<li><strong>User Service</strong>: Creates or retrieves user account</li>
<li><strong>Wallet Service</strong>: Creates or links wallet address</li>
<li><strong>Split Service</strong>: Creates split from invoice data</li>
</ol>
<hr />
<h2 id="step-by-step-implementation-process">Step-by-Step Implementation Process<a class="headerlink" href="#step-by-step-implementation-process" title="Permanent link">&para;</a></h2>
<h3 id="step-1-request-reception-security-validation">Step 1: Request Reception &amp; Security Validation<a class="headerlink" href="#step-1-request-reception-security-validation" title="Permanent link">&para;</a></h3>
<h4 id="11-receive-http-request">1.1 Receive HTTP Request<a class="headerlink" href="#11-receive-http-request" title="Permanent link">&para;</a></h4>
<p><strong>Location</strong>: <code>services/firebase-functions/src/externalPaymentIntegration.js</code></p>
<p><strong>What happens:</strong>
1. Firebase Function receives POST request at <code>/createSplitFromPayment</code>
2. CORS middleware processes the request
3. Request method is validated (must be POST)</p>
<p><strong>Security Check:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">405</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Method not allowed. Use POST.&#39;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="12-extract-and-validate-api-key">1.2 Extract and Validate API Key<a class="headerlink" href="#12-extract-and-validate-api-key" title="Permanent link">&para;</a></h4>
<p><strong>Security Requirement:</strong> All requests must include valid API key.</p>
<p><strong>What happens:</strong>
1. Extract API key from <code>Authorization</code> header
2. Validate format: <code>Bearer YOUR_API_KEY</code>
3. Query Firestore <code>apiKeys</code> collection for matching key
4. Check if key is active and not expired
5. Update usage statistics (lastUsedAt, usageCount)</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">// Extract API key</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">authHeader</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Missing or invalid Authorization header&#39;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="p">}</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kd">const</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">authHeader</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;Bearer &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1">// Validate API key</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="kd">const</span><span class="w"> </span><span class="nx">keyValidation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">validateApiKey</span><span class="p">(</span><span class="nx">apiKey</span><span class="p">);</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">keyValidation</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">401</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">keyValidation</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Invalid API key&#39;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>What we check:</strong>
- ✅ API key exists in Firestore
- ✅ API key is active (<code>active: true</code>)
- ✅ API key is not expired (if <code>expiresAt</code> is set)
- ✅ Update usage tracking</p>
<h4 id="13-rate-limiting-check">1.3 Rate Limiting Check<a class="headerlink" href="#13-rate-limiting-check" title="Permanent link">&para;</a></h4>
<p><strong>Security Requirement:</strong> Prevent abuse with rate limiting.</p>
<p><strong>What happens:</strong>
1. Extract client IP address
2. Check rate limit for API key + IP combination
3. Limit: 100 requests per 15 minutes
4. Return 429 if limit exceeded</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">clientIp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-forwarded-for&#39;</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">                 </span><span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">rateLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkRateLimit</span><span class="p">(</span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">clientIp</span><span class="p">);</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rateLimit</span><span class="p">.</span><span class="nx">allowed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">429</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Rate limit exceeded&#39;</span><span class="p">,</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="nx">retryAfter</span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">rateLimit</span><span class="p">.</span><span class="nx">resetTime</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">()</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="p">}</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1">// Add rate limit headers</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;X-RateLimit-Limit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;100&#39;</span><span class="p">);</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;X-RateLimit-Remaining&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">rateLimit</span><span class="p">.</span><span class="nx">remaining</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
</code></pre></div></p>
<h4 id="14-input-sanitization">1.4 Input Sanitization<a class="headerlink" href="#14-input-sanitization" title="Permanent link">&para;</a></h4>
<p><strong>Security Requirement:</strong> Prevent XSS and injection attacks.</p>
<p><strong>What happens:</strong>
1. Recursively sanitize all string inputs
2. Remove script tags and JavaScript handlers
3. Trim whitespace
4. Validate data types</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">paymentData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sanitizeInput</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
</code></pre></div></p>
<p><strong>What we sanitize:</strong>
- All string fields (email, invoiceId, merchant name, etc.)
- Nested objects (merchant, items)
- Arrays (items array)</p>
<hr />
<h3 id="step-2-data-validation">Step 2: Data Validation<a class="headerlink" href="#step-2-data-validation" title="Permanent link">&para;</a></h3>
<h4 id="21-validate-required-fields">2.1 Validate Required Fields<a class="headerlink" href="#21-validate-required-fields" title="Permanent link">&para;</a></h4>
<p><strong>What we validate:</strong></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Validation Rules</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>email</code></td>
<td>Must be valid email format, non-empty string</td>
</tr>
<tr>
<td><code>invoiceId</code></td>
<td>Must be non-empty string</td>
</tr>
<tr>
<td><code>amount</code></td>
<td>Must be positive number, &gt; 0, &lt;= 1,000,000</td>
</tr>
<tr>
<td><code>currency</code></td>
<td>Must be non-empty string (ISO 4217 format)</td>
</tr>
<tr>
<td><code>merchant.name</code></td>
<td>Must be non-empty string</td>
</tr>
<tr>
<td><code>transactionDate</code></td>
<td>Must be valid ISO 8601 date string</td>
</tr>
<tr>
<td><code>source</code></td>
<td>Must be non-empty string</td>
</tr>
</tbody>
</table>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">validatePaymentData</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">);</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">validation</span><span class="p">.</span><span class="nx">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Validation failed&#39;</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="nx">errors</span><span class="o">:</span><span class="w"> </span><span class="nx">validation</span><span class="p">.</span><span class="nx">errors</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="22-validate-optional-fields-if-provided">2.2 Validate Optional Fields (if provided)<a class="headerlink" href="#22-validate-optional-fields-if-provided" title="Permanent link">&para;</a></h4>
<p><strong>What we validate:</strong>
- <code>walletAddress</code>: Must be valid Solana address (32-44 characters, base58)
- <code>items</code>: Each item must have name (string) and price (positive number)
- <code>subtotal</code>, <code>tax</code>, <code>tip</code>: Must be positive numbers if provided</p>
<hr />
<h3 id="step-3-user-account-management">Step 3: User Account Management<a class="headerlink" href="#step-3-user-account-management" title="Permanent link">&para;</a></h3>
<h4 id="31-check-if-user-exists">3.1 Check if User Exists<a class="headerlink" href="#31-check-if-user-exists" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Query Firestore <code>users</code> collection by email (case-insensitive)
2. Use <code>where('email', '==', email.toLowerCase().trim())</code>
3. Limit to 1 result</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">usersRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">emailQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">usersRef</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;==&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">trim</span><span class="p">())</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
</code></pre></div></p>
<h4 id="32-handle-existing-user">3.2 Handle Existing User<a class="headerlink" href="#32-handle-existing-user" title="Permanent link">&para;</a></h4>
<p><strong>If user exists:</strong></p>
<p><strong>Scenario A: Wallet address provided and matches</strong>
- ✅ User found, wallet matches
- ✅ Return existing user
- ✅ No updates needed</p>
<p><strong>Scenario B: Wallet address provided but different</strong>
- ✅ User found, but wallet address is different
- ✅ Update user's <code>wallet_address</code> field
- ✅ Add to <code>linkedWallets</code> collection as external wallet
- ✅ Set <code>wallet_type</code> to 'external'
- ✅ Return updated user</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">emailQuery</span><span class="p">.</span><span class="nx">empty</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">emailQuery</span><span class="p">.</span><span class="nx">docs</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">userData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userDoc</span><span class="p">.</span><span class="nx">data</span><span class="p">();</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="c1">// Update wallet if provided and different</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">walletAddress</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">wallet_address</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">walletAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="c1">// Update user document</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">userDoc</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">      </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="nx">walletAddress</span><span class="p">,</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">      </span><span class="nx">wallet_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;external&#39;</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">      </span><span class="nx">updated_at</span><span class="o">:</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">()</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="c1">// Add to linked wallets</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;linkedWallets&#39;</span><span class="p">).</span><span class="nx">add</span><span class="p">({</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">userDoc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">      </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;external&#39;</span><span class="p">,</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">      </span><span class="nx">label</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;External Wallet&#39;</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">      </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="nx">walletAddress</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">      </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">()</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">userDoc</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">userData</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="33-create-new-user">3.3 Create New User<a class="headerlink" href="#33-create-new-user" title="Permanent link">&para;</a></h4>
<p><strong>If user doesn't exist:</strong></p>
<p><strong>Scenario A: Wallet address provided (External Wallet)</strong>
- ✅ Create new user with provided wallet
- ✅ Set <code>wallet_type</code> to 'external'
- ✅ Set <code>wallet_status</code> to 'healthy'
- ✅ Set <code>hasCompletedOnboarding</code> to false
- ⚠️ <strong>Note</strong>: This is an external wallet (e.g., from "spend"). WeSplit wallet will be created when user opens app.</p>
<p><strong>Scenario B: No wallet address provided</strong>
- ✅ Create new user without wallet
- ✅ Set <code>wallet_type</code> to 'app-generated'
- ✅ Set <code>wallet_status</code> to 'no_wallet'
- ⚠️ <strong>Important</strong>: WeSplit wallet will be created when user first opens the app
- ✅ Set <code>hasCompletedOnboarding</code> to false
- ✅ Split can still be created (works with empty wallet address)</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1">// User doesn&#39;t exist - create new user</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">newUserData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">trim</span><span class="p">(),</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="c1">// Default name from email</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="nx">walletAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">  </span><span class="nx">wallet_public_key</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">  </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">(),</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">  </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">  </span><span class="nx">hasCompletedOnboarding</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">  </span><span class="nx">email_verified</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">  </span><span class="nx">wallet_status</span><span class="o">:</span><span class="w"> </span><span class="nx">walletAddress</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;healthy&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;no_wallet&#39;</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">  </span><span class="nx">wallet_type</span><span class="o">:</span><span class="w"> </span><span class="nx">walletAddress</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;external&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;app-generated&#39;</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">  </span><span class="nx">wallet_migration_status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">  </span><span class="nx">points</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">  </span><span class="nx">total_points_earned</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">  </span><span class="nx">firebase_uid</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">  </span><span class="nx">primary_email</span><span class="o">:</span><span class="w"> </span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="p">};</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="kd">const</span><span class="w"> </span><span class="nx">newUserRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">usersRef</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">newUserData</span><span class="p">);</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="nx">newUserRef</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">newUserData</span><span class="w"> </span><span class="p">};</span>
</code></pre></div></p>
<p><strong>User Document Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU&quot;</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">  </span><span class="nx">wallet_type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// or &quot;app-generated&quot;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">  </span><span class="nx">wallet_status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;healthy&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// or &quot;no_wallet&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">  </span><span class="nx">hasCompletedOnboarding</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">  </span><span class="nx">points</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">  </span><span class="nx">created_at</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">  </span><span class="c1">// ... other fields</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="p">}</span>
</code></pre></div></p>
<hr />
<h3 id="step-4-currency-conversion">Step 4: Currency Conversion<a class="headerlink" href="#step-4-currency-conversion" title="Permanent link">&para;</a></h3>
<h4 id="41-convert-amount-to-usdc">4.1 Convert Amount to USDC<a class="headerlink" href="#41-convert-amount-to-usdc" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Check if currency is USD or USDC (1:1 conversion)
2. For other currencies, apply conversion rate
3. Round to 2 decimal places</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">function</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">fromCurrency</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">upperCurrency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fromCurrency</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">upperCurrency</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">upperCurrency</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">amount</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">  </span><span class="c1">// TODO: Implement currency conversion API</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">  </span><span class="c1">// For now, assume USD</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">amount</span><span class="p">;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Note:</strong> In production, integrate with a currency conversion API (e.g., ExchangeRate-API, Fixer.io).</p>
<hr />
<h3 id="step-5-split-creation">Step 5: Split Creation<a class="headerlink" href="#step-5-split-creation" title="Permanent link">&para;</a></h3>
<h4 id="51-transform-payment-data-to-split-format">5.1 Transform Payment Data to Split Format<a class="headerlink" href="#51-transform-payment-data-to-split-format" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Generate unique bill ID: <code>bill_${Date.now()}_${random}</code>
2. Create split title from invoice number or ID
3. Convert all amounts to USDC
4. Transform items array (if provided)
5. Create participant array with user</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">// Generate bill ID</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">billId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">generateBillId</span><span class="p">();</span><span class="w"> </span><span class="c1">// e.g., &quot;bill_1234567890_abc123&quot;</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1">// Convert amounts</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">totalAmountUSDC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">);</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="kd">const</span><span class="w"> </span><span class="nx">subtotalUSDC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">subtotal</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">  </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">subtotal</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="kd">const</span><span class="w"> </span><span class="nx">taxUSDC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">tax</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">  </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">tax</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="c1">// Transform items</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="kd">const</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]).</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`item_</span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">  </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">  </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">category</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">  </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">  </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="p">}));</span>
</code></pre></div></p>
<h4 id="52-create-split-document">5.2 Create Split Document<a class="headerlink" href="#52-create-split-document" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Create split data structure
2. Set status to 'pending'
3. Set splitType to 'fair'
4. Add user as participant with 'accepted' status
5. Save to Firestore <code>splits</code> collection</p>
<p><strong>Split Document Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;split_1234567890_abc&quot;</span><span class="p">,</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">  </span><span class="nx">billId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bill_1234567890_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Invoice 2024-001&quot;</span><span class="p">,</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Split for Example Restaurant&quot;</span><span class="p">,</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span><span class="w"> </span><span class="c1">// USDC</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="nx">splitType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;fair&quot;</span><span class="p">,</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">  </span><span class="nx">creatorId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">  </span><span class="nx">creatorName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">  </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU&quot;</span><span class="p">,</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w">    </span><span class="nx">amountOwed</span><span class="o">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w">    </span><span class="nx">amountPaid</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;accepted&quot;</span><span class="p">,</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="w">    </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="w">  </span><span class="p">}],</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[...],</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="w">  </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Example Restaurant&quot;</span><span class="p">,</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;123 Main St&quot;</span><span class="p">,</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="w">    </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;+1234567890&quot;</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="w">  </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2024-01-15T12:30:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w">  </span><span class="nx">subtotal</span><span class="o">:</span><span class="w"> </span><span class="mf">90.00</span><span class="p">,</span>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w">  </span><span class="nx">tax</span><span class="o">:</span><span class="w"> </span><span class="mf">10.00</span><span class="p">,</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="w">  </span><span class="nx">receiptNumber</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;RCP-12345&quot;</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">splitData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`split_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="nx">billId</span><span class="o">:</span><span class="w"> </span><span class="nx">billId</span><span class="p">,</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="sb">`Invoice </span><span class="si">${</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">invoiceNumber</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">invoiceId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="sb">`Split for </span><span class="si">${</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">merchant</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">  </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="nx">totalAmountUSDC</span><span class="p">,</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">,</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">  </span><span class="nx">splitType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="p">,</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="p">,</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">  </span><span class="nx">creatorId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="w">  </span><span class="nx">creatorName</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">  </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">wallet_address</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="w">    </span><span class="nx">amountOwed</span><span class="o">:</span><span class="w"> </span><span class="nx">totalAmountUSDC</span><span class="p">,</span>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a><span class="w">    </span><span class="nx">amountPaid</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a><span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="p">,</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a><span class="w">    </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a><span class="w">  </span><span class="p">}],</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="nx">items</span><span class="p">,</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="w">  </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">merchant</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="w">    </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">merchant</span><span class="p">.</span><span class="nx">address</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a><span class="w">    </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">merchant</span><span class="p">.</span><span class="nx">phone</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="w">  </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">transactionDate</span><span class="p">,</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">(),</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a><span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nx">admin</span><span class="p">.</span><span class="nx">firestore</span><span class="p">.</span><span class="nx">FieldValue</span><span class="p">.</span><span class="nx">serverTimestamp</span><span class="p">(),</span>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="w">  </span><span class="nx">subtotal</span><span class="o">:</span><span class="w"> </span><span class="nx">subtotalUSDC</span><span class="p">,</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="w">  </span><span class="nx">tax</span><span class="o">:</span><span class="w"> </span><span class="nx">taxUSDC</span><span class="p">,</span>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="w">  </span><span class="nx">receiptNumber</span><span class="o">:</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">receiptNumber</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">invoiceNumber</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="p">};</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a><span class="c1">// Save to Firestore</span>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a><span class="kd">const</span><span class="w"> </span><span class="nx">splitsRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;splits&#39;</span><span class="p">);</span>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="kd">const</span><span class="w"> </span><span class="nx">splitDocRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">splitsRef</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">splitData</span><span class="p">);</span>
</code></pre></div></p>
<h4 id="53-store-split-in-firestore">5.3 Store Split in Firestore<a class="headerlink" href="#53-store-split-in-firestore" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Split document is created in <code>splits</code> collection
2. Split includes metadata to identify external source:
   - <code>externalSource</code>: The source identifier (e.g., "external-web-app")
   - <code>externalInvoiceId</code>: Original invoice ID for reference
   - <code>externalMetadata</code>: Any additional metadata provided
3. Split is stored with all invoice details
4. User is set as creator and participant with 'accepted' status</p>
<p><strong>Split Document Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;split_1234567890_abc&quot;</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span><span class="nx">billId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bill_1234567890_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Invoice 2024-001&quot;</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Split for Example Restaurant&quot;</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">  </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span><span class="nx">splitType</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;fair&quot;</span><span class="p">,</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// User can invite others and create wallet</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">  </span><span class="nx">creatorId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">  </span><span class="nx">creatorName</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">    </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU&quot;</span><span class="p">,</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="w">    </span><span class="nx">amountOwed</span><span class="o">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="w">    </span><span class="nx">amountPaid</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a><span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;accepted&quot;</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="w">  </span><span class="p">}],</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[...],</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a><span class="w">  </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="p">{...},</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a><span class="w">  </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2024-01-15T12:30:00Z&quot;</span><span class="p">,</span>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="w">  </span><span class="nx">updatedAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a><span class="w">  </span><span class="c1">// External payment tracking</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">  </span><span class="nx">externalSource</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;external-web-app&quot;</span><span class="p">,</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="w">  </span><span class="nx">externalInvoiceId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;INV-2024-001&quot;</span><span class="p">,</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="w">  </span><span class="nx">externalMetadata</span><span class="o">:</span><span class="w"> </span><span class="p">{...}</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="p">}</span>
</code></pre></div></p>
<h4 id="54-return-response">5.4 Return Response<a class="headerlink" href="#54-return-response" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Build success response with user and split information
2. Include redirect URL if callback URL provided
3. Return 200 status with JSON response</p>
<p><strong>Response Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user_abc123&quot;</span><span class="p">,</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU&quot;</span><span class="p">,</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="nx">splitId</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;split_1234567890_abc&quot;</span><span class="p">,</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">    </span><span class="nx">splitStatus</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">    </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="mf">100.00</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;USDC&quot;</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2024-01-15T12:30:00Z&quot;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">  </span><span class="nx">redirectUrl</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;https://your-app.com/success?splitId=split_1234567890_abc&amp;userId=user_abc123&amp;status=success&quot;</span><span class="w"> </span><span class="c1">// if callbackUrl provided</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="nx">userEmail</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">    </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">wallet_address</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="nx">splitId</span><span class="o">:</span><span class="w"> </span><span class="nx">split</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="nx">splitStatus</span><span class="o">:</span><span class="w"> </span><span class="nx">split</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">    </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="nx">split</span><span class="p">.</span><span class="nx">totalAmount</span><span class="p">,</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="nx">split</span><span class="p">.</span><span class="nx">currency</span><span class="p">,</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">    </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">split</span><span class="p">.</span><span class="nx">createdAt</span><span class="o">?</span><span class="p">.</span><span class="nx">toDate</span><span class="o">?</span><span class="p">.()</span><span class="o">?</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">};</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="c1">// Add redirect URL if callback URL provided</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">callbackUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="w">  </span><span class="nx">response</span><span class="p">.</span><span class="nx">redirectUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">callbackUrl</span><span class="si">}</span><span class="sb">?splitId=</span><span class="si">${</span><span class="nx">split</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">&amp;userId=</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb">&amp;status=success`</span><span class="p">;</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="p">}</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</code></pre></div></p>
<hr />
<h3 id="step-6-how-users-see-and-interact-with-the-split">Step 6: How Users See and Interact with the Split<a class="headerlink" href="#step-6-how-users-see-and-interact-with-the-split" title="Permanent link">&para;</a></h3>
<h4 id="61-split-appears-in-users-split-list">6.1 Split Appears in User's Split List<a class="headerlink" href="#61-split-appears-in-users-split-list" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. Split is stored in Firestore <code>splits</code> collection
2. When user opens the app and navigates to Splits List:
   - <code>SplitStorageService.getUserSplits()</code> is called
   - Query finds splits where user is creator (all statuses)
   - Split appears in their list because <code>creatorId === user.id</code>
3. Split shows with:
   - Title: "Invoice 2024-001"
   - Merchant name
   - Total amount
   - Status: "Pending"
   - Creation date</p>
<p><strong>User sees:</strong>
- Split card in their splits list
- Can tap to open split details
- Can see it's their split (marked as "Owner")</p>
<p><strong>⚠️ Important: WeSplit Wallet Creation</strong>
- If user doesn't have a WeSplit wallet yet, they will be prompted to create one when they first open the app
- This is a one-time setup that happens automatically when they open the app
- The split is already created and visible - wallet creation is just for payment collection
- User can view the split immediately, even before wallet is created</p>
<h4 id="62-user-opens-split-details">6.2 User Opens Split Details<a class="headerlink" href="#62-user-opens-split-details" title="Permanent link">&para;</a></h4>
<p><strong>What happens when user taps the split:</strong>
1. Navigation to <code>SplitDetailsScreen</code> with split data
2. Split details are loaded from Firestore
3. User sees:
   - Invoice details (merchant, date, amount)
   - Line items (if provided)
   - Subtotal, tax, tip breakdown
   - Receipt number
   - Current participants (just them for now)</p>
<p><strong>User can:</strong>
- View all invoice details
- See the breakdown of items
- Invite other users to split the bill (optional)
- Proceed to create split wallet and collect payments</p>
<h4 id="63-user-can-invite-others-optional">6.3 User Can Invite Others (Optional)<a class="headerlink" href="#63-user-can-invite-others-optional" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. User can tap "Invite" button in SplitDetailsScreen
2. Select contacts to invite
3. Invited users receive notification
4. When they accept, they're added as participants
5. Amounts are recalculated (equal split by default)</p>
<p><strong>If user doesn't invite others:</strong>
- Split remains with just the creator
- User can still create split wallet
- Can collect payment from themselves (for tracking purposes)
- Or mark as personal expense</p>
<h4 id="64-user-creates-split-wallet-when-ready">6.4 User Creates Split Wallet (When Ready)<a class="headerlink" href="#64-user-creates-split-wallet-when-ready" title="Permanent link">&para;</a></h4>
<p><strong>What happens:</strong>
1. User navigates to FairSplit screen
2. Creates split wallet for collecting payments
3. Split wallet is created with participants
4. Split status changes to 'active'
5. Participants can pay their share
6. Creator can withdraw funds when all paid</p>
<p><strong>Flow:</strong>
- SplitDetails → Select "Split" → Choose "Fair Split" → FairSplitScreen → Create Wallet → Collect Payments</p>
<hr />
<h3 id="step-7-data-storage-and-distribution">Step 7: Data Storage and Distribution<a class="headerlink" href="#step-7-data-storage-and-distribution" title="Permanent link">&para;</a></h3>
<h4 id="71-where-data-is-stored">7.1 Where Data is Stored<a class="headerlink" href="#71-where-data-is-stored" title="Permanent link">&para;</a></h4>
<p><strong>Firestore Collections:</strong></p>
<ol>
<li><strong><code>users</code> collection:</strong></li>
<li>User document with email, wallet address</li>
<li>
<p>Created/updated when payment received</p>
</li>
<li>
<p><strong><code>splits</code> collection:</strong></p>
</li>
<li>Split document with all invoice details</li>
<li>Includes <code>externalSource</code>, <code>externalInvoiceId</code> for tracking</li>
<li>
<p>User is creator and participant</p>
</li>
<li>
<p><strong><code>linkedWallets</code> collection (if wallet provided):</strong></p>
</li>
<li>
<p>External wallet linked to user account</p>
</li>
<li>
<p><strong><code>apiKeys</code> collection:</strong></p>
</li>
<li>API key usage tracking</li>
</ol>
<h4 id="72-how-data-is-distributed-to-users">7.2 How Data is Distributed to Users<a class="headerlink" href="#72-how-data-is-distributed-to-users" title="Permanent link">&para;</a></h4>
<p><strong>Automatic Distribution:</strong>
- Split appears in user's splits list automatically (they're creator)
- No notification needed (user created it via external payment)
- User can access it immediately when they open the app</p>
<p><strong>If User Invites Others:</strong>
- Invited users receive notification
- They can accept invitation
- They're added as participants
- They see the split in their list</p>
<p><strong>Real-time Updates:</strong>
- Split uses Firestore real-time listeners
- Changes sync automatically
- Participants see updates in real-time</p>
<h4 id="73-data-flow-summary">7.3 Data Flow Summary<a class="headerlink" href="#73-data-flow-summary" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>External Payment
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    ↓
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Firebase Function
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    ↓
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>Create/Get User (Firestore: users)
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    ↓
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>Create Split (Firestore: splits)
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    ↓
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>User Opens App
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    ↓
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>SplitsListScreen loads splits
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    ↓
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>Split appears in list (user is creator)
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    ↓
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>User taps split
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    ↓
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>SplitDetailsScreen shows invoice
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    ↓
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>User can:
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>  - View invoice details
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>  - Invite others (optional)
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>  - Create split wallet
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>  - Collect payments
</code></pre></div>
<hr />
<h3 id="step-8-important-implementation-notes">Step 8: Important Implementation Notes<a class="headerlink" href="#step-8-important-implementation-notes" title="Permanent link">&para;</a></h3>
<h4 id="81-split-status-flow">8.1 Split Status Flow<a class="headerlink" href="#81-split-status-flow" title="Permanent link">&para;</a></h4>
<p><strong>Initial State:</strong>
- Status: <code>'pending'</code>
- User can view, edit, invite others</p>
<p><strong>After User Creates Wallet:</strong>
- Status: <code>'active'</code>
- Participants can pay
- Creator can collect payments</p>
<p><strong>After All Payments Collected:</strong>
- Status: <code>'completed'</code>
- Creator can withdraw funds</p>
<h4 id="82-participant-management">8.2 Participant Management<a class="headerlink" href="#82-participant-management" title="Permanent link">&para;</a></h4>
<p><strong>Initial:</strong>
- Only creator is participant
- Status: <code>'accepted'</code>
- Amount owed: Full amount</p>
<p><strong>After Inviting Others:</strong>
- New participants added
- Amounts recalculated (equal split)
- Status: <code>'invited'</code> → <code>'accepted'</code> when they join</p>
<h4 id="83-metadata-tracking">8.3 Metadata Tracking<a class="headerlink" href="#83-metadata-tracking" title="Permanent link">&para;</a></h4>
<p><strong>Stored in Split:</strong>
- <code>externalSource</code>: Identifies which external app created it
- <code>externalInvoiceId</code>: Original invoice ID for reference
- <code>externalMetadata</code>: Additional metadata from external app</p>
<p><strong>Use Cases:</strong>
- Analytics: Track which external apps create splits
- Support: Identify source of issues
- Reconciliation: Match external invoices with splits
- Filtering: Filter splits by source (if needed in future)</p>
<hr />
<h3 id="step-6-error-handling">Step 6: Error Handling<a class="headerlink" href="#step-6-error-handling" title="Permanent link">&para;</a></h3>
<h4 id="61-error-types-and-responses">6.1 Error Types and Responses<a class="headerlink" href="#61-error-types-and-responses" title="Permanent link">&para;</a></h4>
<p><strong>Validation Errors (400):</strong>
- Missing required fields
- Invalid data format
- Invalid email format
- Invalid amount (negative or zero)</p>
<p><strong>Authentication Errors (401):</strong>
- Missing API key
- Invalid API key
- Expired API key</p>
<p><strong>Rate Limit Errors (429):</strong>
- Too many requests
- Includes <code>retryAfter</code> timestamp</p>
<p><strong>Server Errors (500):</strong>
- Database errors
- Internal processing errors</p>
<p><strong>Implementation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error in createSplitFromPayment:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">functions</span><span class="p">.</span><span class="nx">https</span><span class="p">.</span><span class="nx">HttpsError</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;internal&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Internal server error&#39;</span><span class="p">,</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">  </span><span class="p">});</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="p">}</span>
</code></pre></div></p>
<hr />
<h2 id="security-implementation-details">Security Implementation Details<a class="headerlink" href="#security-implementation-details" title="Permanent link">&para;</a></h2>
<h3 id="api-key-storage">API Key Storage<a class="headerlink" href="#api-key-storage" title="Permanent link">&para;</a></h3>
<p><strong>Location:</strong> Firestore <code>apiKeys</code> collection</p>
<p><strong>Structure:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;hashed_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// SHA-256 hash of actual key</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;external-app-name&quot;</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="nx">active</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">  </span><span class="nx">expiresAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span><span class="w"> </span><span class="c1">// Optional</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">  </span><span class="nx">lastUsedAt</span><span class="o">:</span><span class="w"> </span><span class="nx">Timestamp</span><span class="p">,</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">  </span><span class="nx">usageCount</span><span class="o">:</span><span class="w"> </span><span class="nx">number</span><span class="p">,</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">  </span><span class="nx">permissions</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">[],</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">  </span><span class="nx">rateLimit</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="nx">maxRequests</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="nx">windowMs</span><span class="o">:</span><span class="w"> </span><span class="mf">900000</span><span class="w"> </span><span class="c1">// 15 minutes</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">  </span><span class="p">},</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="nx">contactEmail</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">,</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">    </span><span class="nx">allowedIps</span><span class="o">:</span><span class="w"> </span><span class="nx">string</span><span class="p">[]</span><span class="w"> </span><span class="c1">// Optional IP whitelist</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="rate-limiting">Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permanent link">&para;</a></h3>
<p><strong>Implementation:</strong> In-memory Map (for Firebase Functions)
- Key: <code>${apiKey}_${ip}</code>
- Value: <code>{ count: number, resetTime: timestamp }</code>
- Limit: 100 requests per 15 minutes
- Auto-reset after window expires</p>
<p><strong>Future Enhancement:</strong> Use Redis or Firestore for distributed rate limiting</p>
<h3 id="input-sanitization">Input Sanitization<a class="headerlink" href="#input-sanitization" title="Permanent link">&para;</a></h3>
<p><strong>What we sanitize:</strong>
- Remove <code>&lt;script&gt;</code> tags
- Remove <code>javascript:</code> protocol
- Remove event handlers (<code>onclick</code>, <code>onerror</code>, etc.)
- Trim whitespace
- Validate data types</p>
<hr />
<h2 id="monitoring-logging">Monitoring &amp; Logging<a class="headerlink" href="#monitoring-logging" title="Permanent link">&para;</a></h2>
<h3 id="what-we-log">What We Log<a class="headerlink" href="#what-we-log" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>API Key Usage:</strong></li>
<li>Key ID</li>
<li>Timestamp</li>
<li>IP address</li>
<li>Endpoint</li>
<li>
<p>Success/failure</p>
</li>
<li>
<p><strong>Request Details:</strong></p>
</li>
<li>Request ID</li>
<li>Source</li>
<li>Response time</li>
<li>
<p>Status code</p>
</li>
<li>
<p><strong>Errors:</strong></p>
</li>
<li>Error type</li>
<li>Error message</li>
<li>Request context</li>
</ol>
<h3 id="what-we-dont-log">What We Don't Log<a class="headerlink" href="#what-we-dont-log" title="Permanent link">&para;</a></h3>
<ul>
<li>Full API keys (only key ID)</li>
<li>Sensitive user data</li>
<li>Full request bodies (only metadata)</li>
</ul>
<hr />
<h2 id="testing-scenarios">Testing Scenarios<a class="headerlink" href="#testing-scenarios" title="Permanent link">&para;</a></h2>
<h3 id="test-case-1-new-user-with-wallet">Test Case 1: New User with Wallet<a class="headerlink" href="#test-case-1-new-user-with-wallet" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Input:</strong> Email + Wallet Address</li>
<li><strong>Expected:</strong> User created with external wallet, split created</li>
<li><strong>Verify:</strong> User document, wallet linked, split document</li>
</ul>
<h3 id="test-case-2-new-user-without-wallet">Test Case 2: New User without Wallet<a class="headerlink" href="#test-case-2-new-user-without-wallet" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Input:</strong> Email only</li>
<li><strong>Expected:</strong> User created, wallet_status = 'no_wallet', split created</li>
<li><strong>Verify:</strong> User document, split document</li>
</ul>
<h3 id="test-case-3-existing-user">Test Case 3: Existing User<a class="headerlink" href="#test-case-3-existing-user" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Input:</strong> Existing email</li>
<li><strong>Expected:</strong> User retrieved, split created</li>
<li><strong>Verify:</strong> No duplicate user, split document</li>
</ul>
<h3 id="test-case-4-existing-user-with-new-wallet">Test Case 4: Existing User with New Wallet<a class="headerlink" href="#test-case-4-existing-user-with-new-wallet" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Input:</strong> Existing email + new wallet address</li>
<li><strong>Expected:</strong> User updated, wallet linked, split created</li>
<li><strong>Verify:</strong> User document updated, linkedWallets entry, split document</li>
</ul>
<h3 id="test-case-5-invalid-data">Test Case 5: Invalid Data<a class="headerlink" href="#test-case-5-invalid-data" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Input:</strong> Missing required fields</li>
<li><strong>Expected:</strong> 400 error, no user/split created</li>
<li><strong>Verify:</strong> Error response, no database changes</li>
</ul>
<hr />
<h2 id="complete-user-flow-after-split-creation">Complete User Flow After Split Creation<a class="headerlink" href="#complete-user-flow-after-split-creation" title="Permanent link">&para;</a></h2>
<h3 id="how-the-user-sees-the-split">How the User Sees the Split<a class="headerlink" href="#how-the-user-sees-the-split" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>User Opens App:</strong></li>
<li>Navigates to Splits List screen</li>
<li>Split appears automatically (user is creator)</li>
<li>
<p>Shows: Title, merchant, amount, status "Pending"</p>
</li>
<li>
<p><strong>User Taps Split:</strong></p>
</li>
<li>Opens SplitDetailsScreen</li>
<li>
<p>Sees complete invoice details:</p>
<ul>
<li>Merchant information</li>
<li>Transaction date</li>
<li>Line items (if provided)</li>
<li>Subtotal, tax, tip breakdown</li>
<li>Receipt number</li>
</ul>
</li>
<li>
<p><strong>User Can:</strong></p>
</li>
<li><strong>View Invoice</strong>: See all payment details</li>
<li><strong>Invite Others</strong>: Tap "Invite" to add participants (optional)</li>
<li><strong>Create Split Wallet</strong>: Tap "Split" → Choose "Fair Split" → Create wallet</li>
<li>
<p><strong>Collect Payments</strong>: Once wallet created, participants can pay</p>
</li>
<li>
<p><strong>If User Invites Others:</strong></p>
</li>
<li>Invited users receive notification</li>
<li>They accept invitation</li>
<li>Amounts recalculated (equal split)</li>
<li>
<p>All participants can pay their share</p>
</li>
<li>
<p><strong>Payment Collection:</strong></p>
</li>
<li>Participants pay to split wallet</li>
<li>Creator can withdraw when all paid</li>
<li>Split status changes to 'completed'</li>
</ol>
<h3 id="data-storage-locations">Data Storage Locations<a class="headerlink" href="#data-storage-locations" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Data</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>User Account</td>
<td><code>users</code> collection</td>
<td>User identification and wallet</td>
</tr>
<tr>
<td>Split Document</td>
<td><code>splits</code> collection</td>
<td>Invoice and split details</td>
</tr>
<tr>
<td>External Wallet</td>
<td><code>linkedWallets</code> collection</td>
<td>External wallet (if provided)</td>
</tr>
<tr>
<td>API Key Usage</td>
<td><code>apiKeys</code> collection</td>
<td>API key tracking</td>
</tr>
<tr>
<td>Split Wallet</td>
<td><code>splitWallets</code> collection</td>
<td>Created when user creates wallet</td>
</tr>
</tbody>
</table>
<h3 id="how-data-spreads-to-users">How Data Spreads to Users<a class="headerlink" href="#how-data-spreads-to-users" title="Permanent link">&para;</a></h3>
<p><strong>Automatic:</strong>
- Split appears in creator's list immediately
- No notification needed (they created it)</p>
<p><strong>If Others Invited:</strong>
- Invited users receive notification
- They accept → added as participants
- Split appears in their list
- Real-time updates sync to all participants</p>
<hr />
<h2 id="deployment-checklist">Deployment Checklist<a class="headerlink" href="#deployment-checklist" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] Firebase Function deployed</li>
<li>[ ] API key management system ready</li>
<li>[ ] Rate limiting tested</li>
<li>[ ] Error handling tested</li>
<li>[ ] Logging configured</li>
<li>[ ] Monitoring set up</li>
<li>[ ] Documentation complete</li>
<li>[ ] Test endpoint verified</li>
<li>[ ] User flow tested (split appears in list)</li>
<li>[ ] Split details display correctly</li>
<li>[ ] Invitation flow works (if users invite others)</li>
</ul>
<h2 id="data-structures">Data Structures<a class="headerlink" href="#data-structures" title="Permanent link">&para;</a></h2>
<h3 id="incoming-payment-data-format">Incoming Payment Data Format<a class="headerlink" href="#incoming-payment-data-format" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">ExternalPaymentData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">  </span><span class="c1">// User identification</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">  </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Required: User&#39;s email address</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">  </span><span class="nx">walletAddress?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">            </span><span class="c1">// Optional: User&#39;s Solana wallet address</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">  </span><span class="c1">// Payment/Invoice information</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">  </span><span class="nx">invoiceId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Required: Unique invoice identifier</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">  </span><span class="nx">invoiceNumber?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">            </span><span class="c1">// Optional: Human-readable invoice number</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">  </span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Required: Total payment amount</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Required: Currency code (will be converted to USDC)</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">  </span><span class="c1">// Merchant information</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">  </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Required: Merchant name</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">    </span><span class="nx">address?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Optional: Merchant address</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">    </span><span class="nx">phone?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                   </span><span class="c1">// Optional: Merchant phone</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">  </span><span class="c1">// Transaction details</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">  </span><span class="nx">transactionDate</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">           </span><span class="c1">// Required: ISO 8601 date string</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">  </span><span class="nx">items?</span><span class="o">:</span><span class="w"> </span><span class="kt">Array</span><span class="o">&lt;</span><span class="p">{</span><span class="w">                     </span><span class="c1">// Optional: Line items</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">    </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">    </span><span class="nx">quantity?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">    </span><span class="nx">category?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">  </span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">  </span><span class="c1">// Additional metadata</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">  </span><span class="nx">subtotal?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Optional: Subtotal before tax</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">  </span><span class="nx">tax?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Optional: Tax amount</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">  </span><span class="nx">tip?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Optional: Tip amount</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">  </span><span class="nx">receiptNumber?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">            </span><span class="c1">// Optional: Receipt number</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">  </span><span class="c1">// Metadata</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">  </span><span class="nx">source</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                    </span><span class="c1">// Required: Source identifier (e.g., &quot;external-web-app&quot;)</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a><span class="w">  </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span><span class="w">     </span><span class="c1">// Optional: Additional metadata</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a><span class="p">}</span>
</code></pre></div>
<h3 id="processedbilldata-format-internal">ProcessedBillData Format (Internal)<a class="headerlink" href="#processedbilldata-format-internal" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kd">interface</span><span class="w"> </span><span class="nx">ProcessedBillData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                        </span><span class="c1">// Generated bill ID</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">  </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Invoice title</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">  </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                  </span><span class="c1">// Merchant name</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">  </span><span class="nx">location?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                  </span><span class="c1">// Merchant address</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="w">  </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                      </span><span class="c1">// ISO date string</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">  </span><span class="nx">time?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Time string</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">  </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">               </span><span class="c1">// Total amount in USDC</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="w">  </span><span class="nx">subtotal?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                 </span><span class="c1">// Subtotal</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">  </span><span class="nx">tax?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Tax amount</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">  </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">                  </span><span class="c1">// Always &#39;USDC&#39; after conversion</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w">  </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">BillItem</span><span class="p">[];</span><span class="w">                </span><span class="c1">// Line items</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">  </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="kt">BillParticipant</span><span class="p">[];</span><span class="w">  </span><span class="c1">// Participants (user will be added)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">  </span><span class="nx">settings?</span><span class="o">:</span><span class="w"> </span><span class="kt">BillSettings</span><span class="p">;</span><span class="w">          </span><span class="c1">// Split settings</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="w">  </span><span class="nx">receiptNumber?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">            </span><span class="c1">// Receipt number</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">  </span><span class="nx">merchantPhone?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">            </span><span class="c1">// Merchant phone</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="p">}</span>
</code></pre></div>
<h2 id="implementation-details">Implementation Details<a class="headerlink" href="#implementation-details" title="Permanent link">&para;</a></h2>
<h3 id="user-creation-logic">User Creation Logic<a class="headerlink" href="#user-creation-logic" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createOrGetUser</span><span class="p">(</span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">walletAddress?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">  </span><span class="c1">// 1. Check if user exists by email</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">firebaseDataService</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">getUserByEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">    </span><span class="c1">// User exists - update wallet if provided and different</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">walletAddress</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">wallet_address</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">walletAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">      </span><span class="c1">// Option 1: Update existing wallet</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">firebaseDataService</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">updateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w">        </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="kt">walletAddress</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w">      </span><span class="c1">// Option 2: Link as external wallet (preferred for existing users)</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w">      </span><span class="c1">// Use LinkedWalletService to add as external wallet</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="p">;</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w">  </span><span class="c1">// 2. Create new user</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">walletAddress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w">    </span><span class="c1">// User provided wallet - create user with wallet</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">firebaseDataService</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">createUser</span><span class="p">({</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w">      </span><span class="nx">email</span><span class="p">,</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">email.split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="c1">// Default name from email</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w">      </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="kt">walletAddress</span><span class="p">,</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w">      </span><span class="nx">wallet_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;external&#39;</span><span class="p">,</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w">      </span><span class="nx">hasCompletedOnboarding</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a><span class="w">    </span><span class="c1">// No wallet provided - create user and generate wallet</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a><span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">firebaseDataService</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">createUser</span><span class="p">({</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="w">      </span><span class="nx">email</span><span class="p">,</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">email.split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="w">      </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Will be created by wallet service</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="w">      </span><span class="nx">wallet_type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;app-generated&#39;</span><span class="p">,</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a><span class="w">      </span><span class="nx">hasCompletedOnboarding</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a><span class="w">    </span><span class="c1">// Create wallet for new user</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">walletResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">walletService</span><span class="p">.</span><span class="nx">createWallet</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">walletResult</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">walletResult</span><span class="p">.</span><span class="nx">wallet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a><span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">firebaseDataService</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">updateUser</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a><span class="w">        </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="kt">walletResult.wallet.address</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a><span class="w">      </span><span class="p">});</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="p">;</span>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a><span class="p">}</span>
</code></pre></div>
<h3 id="split-creation-logic">Split Creation Logic<a class="headerlink" href="#split-creation-logic" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createSplitFromInvoice</span><span class="p">(</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">User</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">  </span><span class="nx">paymentData</span><span class="o">:</span><span class="w"> </span><span class="kt">ExternalPaymentData</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="w">  </span><span class="c1">// 1. Transform payment data to ProcessedBillData</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">processedBillData</span><span class="o">:</span><span class="w"> </span><span class="kt">ProcessedBillData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">generateBillId</span><span class="p">(),</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="sb">`Invoice </span><span class="si">${</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">invoiceNumber</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">invoiceId</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.merchant.name</span><span class="p">,</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="nx">location</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.merchant.address</span><span class="p">,</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.transactionDate</span><span class="p">,</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="nx">time</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">transactionDate</span><span class="p">).</span><span class="nx">toLocaleTimeString</span><span class="p">(),</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">    </span><span class="nx">subtotal</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.subtotal</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">subtotal</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">    </span><span class="nx">tax</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.tax</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">tax</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">,</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="w">    </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">items</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]).</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="sb">`item_</span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">item.name</span><span class="p">,</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">      </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">convertToUSDC</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">price</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="w">      </span><span class="nx">quantity</span><span class="o">:</span><span class="w"> </span><span class="kt">item.quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a><span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">item.category</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="w">      </span><span class="nx">total</span><span class="o">:</span><span class="w"> </span><span class="kt">convertToUSDC</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">quantity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a><span class="w">      </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a><span class="w">    </span><span class="p">})),</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a><span class="w">    </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a><span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">user.name</span><span class="p">,</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a><span class="w">      </span><span class="nx">wallet_address</span><span class="o">:</span><span class="w"> </span><span class="kt">user.wallet_address</span><span class="p">,</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a><span class="w">      </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">user.wallet_address</span><span class="p">,</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a><span class="w">      </span><span class="nx">amountOwed</span><span class="o">:</span><span class="w"> </span><span class="kt">convertToUSDC</span><span class="p">(</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">amount</span><span class="p">,</span><span class="w"> </span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">currency</span><span class="p">),</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="w">      </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a><span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="w">    </span><span class="p">}],</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="w">    </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="w">      </span><span class="nx">splitMethod</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;equal&#39;</span><span class="p">,</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="w">      </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">,</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="w">      </span><span class="nx">allowPartialPayments</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a><span class="w">      </span><span class="nx">requireAllAccept</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a><span class="w">      </span><span class="nx">autoCalculate</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a><span class="w">      </span><span class="nx">taxIncluded</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.tax</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">undefined</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a><span class="w">    </span><span class="nx">receiptNumber</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.receiptNumber</span><span class="p">,</span>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a><span class="w">    </span><span class="nx">merchantPhone</span><span class="o">:</span><span class="w"> </span><span class="kt">paymentData.merchant.phone</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a><span class="w">  </span><span class="c1">// 2. Create split</span>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">splitData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="w">    </span><span class="nx">billId</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.id</span><span class="p">,</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a><span class="w">    </span><span class="nx">title</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.title</span><span class="p">,</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a><span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="sb">`Split for </span><span class="si">${</span><span class="nx">paymentData</span><span class="p">.</span><span class="nx">merchant</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a><span class="w">    </span><span class="nx">totalAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.totalAmount</span><span class="p">,</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a><span class="w">    </span><span class="nx">currency</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">,</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a><span class="w">    </span><span class="nx">splitType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;fair&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a><span class="w">    </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;pending&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a><span class="w">    </span><span class="nx">creatorId</span><span class="o">:</span><span class="w"> </span><span class="kt">user.id</span><span class="p">,</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a><span class="w">    </span><span class="nx">creatorName</span><span class="o">:</span><span class="w"> </span><span class="kt">user.name</span><span class="p">,</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a><span class="w">    </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.participants.map</span><span class="p">(</span><span class="nx">p</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a><span class="w">      </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">p.id</span><span class="p">,</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">p.name</span><span class="p">,</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a><span class="w">      </span><span class="nx">email</span><span class="o">:</span><span class="w"> </span><span class="kt">user.email</span><span class="p">,</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a><span class="w">      </span><span class="nx">walletAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">p.walletAddress</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">wallet_address</span><span class="p">,</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a><span class="w">      </span><span class="nx">amountOwed</span><span class="o">:</span><span class="w"> </span><span class="kt">p.amountOwed</span><span class="p">,</span>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a><span class="w">      </span><span class="nx">amountPaid</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a><span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;accepted&#39;</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="kd">const</span><span class="p">,</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a><span class="w">      </span><span class="nx">avatar</span><span class="o">:</span><span class="w"> </span><span class="kt">user.avatar</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a><span class="w">    </span><span class="p">})),</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a><span class="w">    </span><span class="nx">items</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.items.map</span><span class="p">(</span><span class="nx">item</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a><span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">item.id</span><span class="p">,</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">item.name</span><span class="p">,</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a><span class="w">      </span><span class="nx">price</span><span class="o">:</span><span class="w"> </span><span class="kt">item.price</span><span class="p">,</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a><span class="w">      </span><span class="nx">participants</span><span class="o">:</span><span class="w"> </span><span class="kt">item.participants</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a><span class="w">    </span><span class="p">})),</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a><span class="w">    </span><span class="nx">merchant</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.merchant</span><span class="p">,</span>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a><span class="w">      </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.location</span><span class="p">,</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a><span class="w">      </span><span class="nx">phone</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.merchantPhone</span>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a><span class="w">    </span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.date</span><span class="p">,</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a><span class="w">    </span><span class="nx">subtotal</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.subtotal</span><span class="p">,</span>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a><span class="w">    </span><span class="nx">tax</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.tax</span><span class="p">,</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a><span class="w">    </span><span class="nx">receiptNumber</span><span class="o">:</span><span class="w"> </span><span class="kt">processedBillData.receiptNumber</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a><span class="w">  </span><span class="p">};</span>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a><span class="w">  </span><span class="c1">// 3. Save split</span>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a><span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">SplitStorageService</span><span class="p">.</span><span class="nx">createSplit</span><span class="p">(</span><span class="nx">splitData</span><span class="p">);</span>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a><span class="p">}</span>
</code></pre></div>
<h2 id="currency-conversion">Currency Conversion<a class="headerlink" href="#currency-conversion" title="Permanent link">&para;</a></h2>
<p>All amounts must be converted to USDC. The system uses USDC as the standard currency for all splits.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kd">function</span><span class="w"> </span><span class="nx">convertToUSDC</span><span class="p">(</span><span class="nx">amount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"> </span><span class="nx">fromCurrency</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">  </span><span class="c1">// In production, use a currency conversion API</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">  </span><span class="c1">// For now, assume 1:1 for USD, implement conversion rates for others</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fromCurrency</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;USD&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">fromCurrency</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;USDC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">amount</span><span class="p">;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="w">  </span><span class="c1">// TODO: Implement currency conversion API integration</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">  </span><span class="c1">// For MVP, return amount as-is (assumes USD)</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">amount</span><span class="p">;</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="p">}</span>
</code></pre></div>
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<h3 id="validation-errors">Validation Errors<a class="headerlink" href="#validation-errors" title="Permanent link">&para;</a></h3>
<ul>
<li>Missing required fields (email, amount, merchant name)</li>
<li>Invalid email format</li>
<li>Invalid wallet address format (if provided)</li>
<li>Invalid amount (must be &gt; 0)</li>
</ul>
<h3 id="user-creation-errors">User Creation Errors<a class="headerlink" href="#user-creation-errors" title="Permanent link">&para;</a></h3>
<ul>
<li>Email already exists with different wallet (handle gracefully)</li>
<li>Wallet creation failure (retry logic)</li>
</ul>
<h3 id="split-creation-errors">Split Creation Errors<a class="headerlink" href="#split-creation-errors" title="Permanent link">&para;</a></h3>
<ul>
<li>Invalid bill data</li>
<li>Database write failures</li>
<li>Transaction rollback on errors</li>
</ul>
<h2 id="security-considerations">Security Considerations<a class="headerlink" href="#security-considerations" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>API Authentication</strong>: Implement API key or OAuth authentication</li>
<li><strong>Rate Limiting</strong>: Prevent abuse with rate limits</li>
<li><strong>Data Validation</strong>: Validate all incoming data</li>
<li><strong>Sanitization</strong>: Sanitize user inputs</li>
<li><strong>Logging</strong>: Log all operations for audit trail</li>
</ol>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<h3 id="test-scenarios">Test Scenarios<a class="headerlink" href="#test-scenarios" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>New User with Wallet</strong></li>
<li>Email: newuser@example.com</li>
<li>Wallet: Provided</li>
<li>
<p>Expected: User created, wallet linked, split created</p>
</li>
<li>
<p><strong>New User without Wallet</strong></p>
</li>
<li>Email: newuser2@example.com</li>
<li>Wallet: Not provided</li>
<li>
<p>Expected: User created, wallet generated, split created</p>
</li>
<li>
<p><strong>Existing User</strong></p>
</li>
<li>Email: existing@example.com</li>
<li>Wallet: Provided (matches)</li>
<li>
<p>Expected: User retrieved, split created</p>
</li>
<li>
<p><strong>Existing User with New Wallet</strong></p>
</li>
<li>Email: existing@example.com</li>
<li>Wallet: New address</li>
<li>
<p>Expected: User retrieved, wallet updated/linked, split created</p>
</li>
<li>
<p><strong>Invalid Data</strong></p>
</li>
<li>Missing email</li>
<li>Invalid amount</li>
<li>Expected: Error returned, no user/split created</li>
</ol>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<ol>
<li>Implement Firebase Function endpoint</li>
<li>Add API authentication</li>
<li>Implement currency conversion</li>
<li>Add comprehensive error handling</li>
<li>Add logging and monitoring</li>
<li>Create integration tests</li>
<li>Document API endpoints for external web app</li>
</ol>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 14, 2026 11:39:08 UTC">January 14, 2026</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.annotate"], "search": "../../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>