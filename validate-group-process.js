const fs = require('fs');
const path = require('path');

console.log('üîç VALIDATING GROUP PROCESS...\n');

// 1. VALIDATE GROUP CREATION FLOW
function validateGroupCreationFlow() {
  console.log('üìä STEP 1: Validating Group Creation Flow...\n');
  
  // Check CreateGroupScreen.tsx
  const createGroupPath = path.join(__dirname, 'src', 'screens', 'CreateGroup', 'CreateGroupScreen.tsx');
  if (fs.existsSync(createGroupPath)) {
    const content = fs.readFileSync(createGroupPath, 'utf8');
    
    console.log('‚úÖ CreateGroupScreen.tsx validation:');
    
    // Check required imports
    const requiredImports = [
      'useApp',
      'Icon',
      'TouchableOpacity',
      'TextInput',
      'Alert'
    ];
    
    requiredImports.forEach(importName => {
      if (content.includes(importName)) {
        console.log(`   ‚úÖ Has ${importName} import`);
      } else {
        console.log(`   ‚ùå Missing ${importName} import`);
      }
    });
    
    // Check form validation
    if (content.includes('title.trim()') && content.includes('description.trim()')) {
      console.log('   ‚úÖ Has form validation');
    } else {
      console.log('   ‚ùå Missing form validation');
    }
    
    // Check group data structure
    if (content.includes('name: title.trim()') && 
        content.includes('description: description.trim()') &&
        content.includes('created_by: currentUser.id')) {
      console.log('   ‚úÖ Has proper group data structure');
    } else {
      console.log('   ‚ùå Missing proper group data structure');
    }
    
    // Check error handling
    if (content.includes('Alert.alert') && content.includes('catch (error)')) {
      console.log('   ‚úÖ Has error handling');
    } else {
      console.log('   ‚ùå Missing error handling');
    }
    
    // Check navigation
    if (content.includes('navigation.navigate(\'GroupCreated\')')) {
      console.log('   ‚úÖ Has proper navigation flow');
    } else {
      console.log('   ‚ùå Missing proper navigation flow');
    }
  } else {
    console.log('‚ùå CreateGroupScreen.tsx not found');
  }
  
  console.log('');
}

// 2. VALIDATE APP CONTEXT GROUP OPERATIONS
function validateAppContextGroupOperations() {
  console.log('üìä STEP 2: Validating AppContext Group Operations...\n');
  
  const appContextPath = path.join(__dirname, 'src', 'context', 'AppContext.tsx');
  if (fs.existsSync(appContextPath)) {
    const content = fs.readFileSync(appContextPath, 'utf8');
    
    console.log('‚úÖ AppContext.tsx validation:');
    
    // Check createGroup function
    if (content.includes('createGroup: async (groupData: any)')) {
      console.log('   ‚úÖ Has createGroup function');
      
      // Check error handling in createGroup
      if (content.includes('throw new Error(\'User not authenticated\')')) {
        console.log('   ‚úÖ Has authentication check in createGroup');
      } else {
        console.log('   ‚ùå Missing authentication check in createGroup');
      }
      
      // Check hybrid service usage
      if (content.includes('hybridDataService.group.createGroup')) {
        console.log('   ‚úÖ Uses hybrid data service for group creation');
      } else {
        console.log('   ‚ùå Not using hybrid data service for group creation');
      }
    } else {
      console.log('   ‚ùå Missing createGroup function');
    }
    
    // Check other group operations
    const groupOperations = [
      'updateGroup',
      'deleteGroup', 
      'leaveGroup',
      'selectGroup'
    ];
    
    groupOperations.forEach(operation => {
      if (content.includes(`${operation}: async`)) {
        console.log(`   ‚úÖ Has ${operation} function`);
      } else {
        console.log(`   ‚ùå Missing ${operation} function`);
      }
    });
    
    // Check state management
    if (content.includes('ADD_GROUP') && content.includes('UPDATE_GROUP') && content.includes('DELETE_GROUP')) {
      console.log('   ‚úÖ Has proper group state management');
    } else {
      console.log('   ‚ùå Missing proper group state management');
    }
    
  } else {
    console.log('‚ùå AppContext.tsx not found');
  }
  
  console.log('');
}

// 3. VALIDATE HYBRID DATA SERVICE
function validateHybridDataService() {
  console.log('üìä STEP 3: Validating Hybrid Data Service...\n');
  
  const hybridServicePath = path.join(__dirname, 'src', 'services', 'hybridDataService.ts');
  if (fs.existsSync(hybridServicePath)) {
    const content = fs.readFileSync(hybridServicePath, 'utf8');
    
    console.log('‚úÖ HybridDataService.ts validation:');
    
    // Check Firebase fallback pattern
    if (content.includes('üîÑ Hybrid: Trying Firebase') && content.includes('üîÑ Hybrid: Firebase failed, falling back to SQLite')) {
      console.log('   ‚úÖ Has proper Firebase fallback pattern');
    } else {
      console.log('   ‚ùå Missing proper Firebase fallback pattern');
    }
    
    // Check group operations
    const groupOperations = [
      'getUserGroups',
      'getGroupDetails',
      'getGroupMembers',
      'createGroup',
      'updateGroup',
      'deleteGroup',
      'leaveGroup'
    ];
    
    groupOperations.forEach(operation => {
      if (content.includes(`${operation}: async`)) {
        console.log(`   ‚úÖ Has ${operation} operation`);
      } else {
        console.log(`   ‚ùå Missing ${operation} operation`);
      }
    });
    
    // Check error handling
    if (content.includes('catch (error)') && content.includes('console.log')) {
      console.log('   ‚úÖ Has error handling and logging');
    } else {
      console.log('   ‚ùå Missing error handling and logging');
    }
    
  } else {
    console.log('‚ùå HybridDataService.ts not found');
  }
  
  console.log('');
}

// 4. VALIDATE FIREBASE DATA SERVICE
function validateFirebaseDataService() {
  console.log('üìä STEP 4: Validating Firebase Data Service...\n');
  
  const firebaseServicePath = path.join(__dirname, 'src', 'services', 'firebaseDataService.ts');
  if (fs.existsSync(firebaseServicePath)) {
    const content = fs.readFileSync(firebaseServicePath, 'utf8');
    
    console.log('‚úÖ FirebaseDataService.ts validation:');
    
    // Check data transformers
    if (content.includes('firebaseDataTransformers') && content.includes('firestoreToGroup') && content.includes('groupToFirestore')) {
      console.log('   ‚úÖ Has data transformers');
    } else {
      console.log('   ‚ùå Missing data transformers');
    }
    
    // Check group creation logic
    if (content.includes('createGroup: async (groupData:') && content.includes('addDoc(collection(db, \'groups\')')) {
      console.log('   ‚úÖ Has group creation logic');
      
      // Check creator as member
      if (content.includes('member_count: 1') && content.includes('user_id: groupData.created_by')) {
        console.log('   ‚úÖ Adds creator as member');
      } else {
        console.log('   ‚ùå Missing creator as member logic');
      }
    } else {
      console.log('   ‚ùå Missing group creation logic');
    }
    
    // Check member count updates
    if (content.includes('updateGroupMemberCount') && content.includes('member_count: memberCount')) {
      console.log('   ‚úÖ Has member count update logic');
    } else {
      console.log('   ‚ùå Missing member count update logic');
    }
    
    // Check expense creation
    if (content.includes('createExpense: async') && content.includes('addDoc(collection(db, \'expenses\')')) {
      console.log('   ‚úÖ Has expense creation logic');
      
      // Check expense count updates
      if (content.includes('expense_count: currentExpenseCount + 1')) {
        console.log('   ‚úÖ Updates expense count');
      } else {
        console.log('   ‚ùå Missing expense count updates');
      }
    } else {
      console.log('   ‚ùå Missing expense creation logic');
    }
    
    // Check balance calculation
    if (content.includes('calculateUserBalance') && content.includes('paid_by === userId.toString()')) {
      console.log('   ‚úÖ Has balance calculation logic');
    } else {
      console.log('   ‚ùå Missing balance calculation logic');
    }
    
  } else {
    console.log('‚ùå FirebaseDataService.ts not found');
  }
  
  console.log('');
}

// 5. VALIDATE GROUP DETAILS SCREEN
function validateGroupDetailsScreen() {
  console.log('üìä STEP 5: Validating Group Details Screen...\n');
  
  const groupDetailsPath = path.join(__dirname, 'src', 'screens', 'GroupDetails', 'GroupDetailsScreen.tsx');
  if (fs.existsSync(groupDetailsPath)) {
    const content = fs.readFileSync(groupDetailsPath, 'utf8');
    
    console.log('‚úÖ GroupDetailsScreen.tsx validation:');
    
    // Check data loading
    if (content.includes('useEffect') && content.includes('hybridDataService')) {
      console.log('   ‚úÖ Has data loading logic');
    } else {
      console.log('   ‚ùå Missing data loading logic');
    }
    
    // Check balance calculations
    if (content.includes('calculateRealBalances') || content.includes('getGroupBalances')) {
      console.log('   ‚úÖ Has balance calculation logic');
    } else {
      console.log('   ‚ùå Missing balance calculation logic');
    }
    
    // Check error handling
    if (content.includes('catch (error)') && content.includes('console.error')) {
      console.log('   ‚úÖ Has error handling');
    } else {
      console.log('   ‚ùå Missing error handling');
    }
    
    // Check loading states
    if (content.includes('setLoadingBalances') && content.includes('setLoadingExpenses')) {
      console.log('   ‚úÖ Has loading states');
    } else {
      console.log('   ‚ùå Missing loading states');
    }
    
    // Check refresh functionality
    if (content.includes('onRefresh') || content.includes('refreshGroup')) {
      console.log('   ‚úÖ Has refresh functionality');
    } else {
      console.log('   ‚ùå Missing refresh functionality');
    }
    
  } else {
    console.log('‚ùå GroupDetailsScreen.tsx not found');
  }
  
  console.log('');
}

// 6. VALIDATE ADD EXPENSE SCREEN
function validateAddExpenseScreen() {
  console.log('üìä STEP 6: Validating Add Expense Screen...\n');
  
  const addExpensePath = path.join(__dirname, 'src', 'screens', 'AddExpense', 'AddExpenseScreen.tsx');
  if (fs.existsSync(addExpensePath)) {
    const content = fs.readFileSync(addExpensePath, 'utf8');
    
    console.log('‚úÖ AddExpenseScreen.tsx validation:');
    
    // Check form validation
    if (content.includes('description.trim()') && content.includes('amount > 0')) {
      console.log('   ‚úÖ Has form validation');
    } else {
      console.log('   ‚ùå Missing form validation');
    }
    
    // Check participant selection
    if (content.includes('selectedParticipants') && content.includes('toggleParticipant')) {
      console.log('   ‚úÖ Has participant selection logic');
    } else {
      console.log('   ‚ùå Missing participant selection logic');
    }
    
    // Check split mode handling
    if (content.includes('splitMode') && (content.includes('equal') || content.includes('manual'))) {
      console.log('   ‚úÖ Has split mode handling');
    } else {
      console.log('   ‚ùå Missing split mode handling');
    }
    
    // Check expense creation
    if (content.includes('createExpense') && content.includes('hybridDataService')) {
      console.log('   ‚úÖ Has expense creation logic');
    } else {
      console.log('   ‚ùå Missing expense creation logic');
    }
    
    // Check currency conversion
    if (content.includes('convertToUSDC') || content.includes('currency conversion')) {
      console.log('   ‚úÖ Has currency conversion logic');
    } else {
      console.log('   ‚ùå Missing currency conversion logic');
    }
    
    // Check paid by field
    if (content.includes('paidBy') || content.includes('paid_by')) {
      console.log('   ‚úÖ Has paid by field');
    } else {
      console.log('   ‚ùå Missing paid by field');
    }
    
  } else {
    console.log('‚ùå AddExpenseScreen.tsx not found');
  }
  
  console.log('');
}

// 7. VALIDATE SETTLE UP MODAL
function validateSettleUpModal() {
  console.log('üìä STEP 7: Validating Settle Up Modal...\n');
  
  const settleUpPath = path.join(__dirname, 'src', 'screens', 'SettleUp', 'SettleUpModal.tsx');
  if (fs.existsSync(settleUpPath)) {
    const content = fs.readFileSync(settleUpPath, 'utf8');
    
    console.log('‚úÖ SettleUpModal.tsx validation:');
    
    // Check balance display
    if (content.includes('userBalances') || content.includes('balance calculations')) {
      console.log('   ‚úÖ Has balance display logic');
    } else {
      console.log('   ‚ùå Missing balance display logic');
    }
    
    // Check settlement handling
    if (content.includes('handleIndividualSettlement') || content.includes('settlement logic')) {
      console.log('   ‚úÖ Has settlement handling');
    } else {
      console.log('   ‚ùå Missing settlement handling');
    }
    
    // Check navigation to send flow
    if (content.includes('navigation.navigate(\'SendAmount\')')) {
      console.log('   ‚úÖ Has navigation to send flow');
    } else {
      console.log('   ‚ùå Missing navigation to send flow');
    }
    
    // Check currency conversion
    if (content.includes('convertToUSD') || content.includes('currency conversion')) {
      console.log('   ‚úÖ Has currency conversion');
    } else {
      console.log('   ‚ùå Missing currency conversion');
    }
    
    // Check error handling
    if (content.includes('catch (error)') || content.includes('Alert.alert')) {
      console.log('   ‚úÖ Has error handling');
    } else {
      console.log('   ‚ùå Missing error handling');
    }
    
  } else {
    console.log('‚ùå SettleUpModal.tsx not found');
  }
  
  console.log('');
}

// 8. VALIDATE DATA CONSISTENCY
function validateDataConsistency() {
  console.log('üìä STEP 8: Validating Data Consistency...\n');
  
  console.log('‚úÖ Data Consistency Checks:');
  
  // Check type definitions
  const typesPath = path.join(__dirname, 'src', 'types', 'index.ts');
  if (fs.existsSync(typesPath)) {
    const content = fs.readFileSync(typesPath, 'utf8');
    
    const requiredTypes = [
      'User',
      'Group',
      'GroupWithDetails',
      'GroupMember',
      'Expense',
      'Balance'
    ];
    
    requiredTypes.forEach(type => {
      if (content.includes(`interface ${type}`) || content.includes(`type ${type}`)) {
        console.log(`   ‚úÖ Has ${type} type definition`);
      } else {
        console.log(`   ‚ùå Missing ${type} type definition`);
      }
    });
    
    // Check ID consistency
    if (content.includes('id: string') || content.includes('id: number')) {
      console.log('   ‚úÖ Has ID type definitions');
    } else {
      console.log('   ‚ùå Missing ID type definitions');
    }
    
  } else {
    console.log('   ‚ùå Types file not found');
  }
  
  // Check service consistency
  const services = [
    'firebaseDataService.ts',
    'hybridDataService.ts',
    'dataService.ts'
  ];
  
  services.forEach(service => {
    const servicePath = path.join(__dirname, 'src', 'services', service);
    if (fs.existsSync(servicePath)) {
      console.log(`   ‚úÖ ${service} exists`);
    } else {
      console.log(`   ‚ùå ${service} missing`);
    }
  });
  
  console.log('');
}

// 9. GENERATE RECOMMENDATIONS
function generateRecommendations() {
  console.log('üìä STEP 9: Generating Recommendations...\n');
  
  console.log('üìã RECOMMENDATIONS FOR GROUP PROCESS:');
  console.log('');
  console.log('1. üõ°Ô∏è  ERROR HANDLING:');
  console.log('   ‚úÖ Implement comprehensive error boundaries');
  console.log('   ‚úÖ Add user-friendly error messages');
  console.log('   ‚úÖ Implement retry mechanisms for failed operations');
  console.log('   ‚úÖ Add offline support and sync when online');
  console.log('');
  console.log('2. üîÑ DATA VALIDATION:');
  console.log('   ‚úÖ Add input validation on all forms');
  console.log('   ‚úÖ Implement server-side validation');
  console.log('   ‚úÖ Add data integrity checks');
  console.log('   ‚úÖ Validate currency amounts and conversions');
  console.log('');
  console.log('3. üöÄ PERFORMANCE:');
  console.log('   ‚úÖ Implement proper loading states');
  console.log('   ‚úÖ Add pagination for large datasets');
  console.log('   ‚úÖ Optimize database queries');
  console.log('   ‚úÖ Implement caching strategies');
  console.log('');
  console.log('4. üîê SECURITY:');
  console.log('   ‚úÖ Validate user permissions for all operations');
  console.log('   ‚úÖ Implement proper authentication checks');
  console.log('   ‚úÖ Add rate limiting for API calls');
  console.log('   ‚úÖ Sanitize all user inputs');
  console.log('');
  console.log('5. üì± USER EXPERIENCE:');
  console.log('   ‚úÖ Add confirmation dialogs for destructive actions');
  console.log('   ‚úÖ Implement undo functionality where possible');
  console.log('   ‚úÖ Add progress indicators for long operations');
  console.log('   ‚úÖ Provide clear feedback for all user actions');
  console.log('');
  console.log('6. üß™ TESTING:');
  console.log('   ‚úÖ Add unit tests for all group operations');
  console.log('   ‚úÖ Implement integration tests for data flow');
  console.log('   ‚úÖ Add end-to-end tests for critical user journeys');
  console.log('   ‚úÖ Test error scenarios and edge cases');
  console.log('');
}

// Main execution
function main() {
  console.log('üöÄ Starting comprehensive group process validation...\n');
  
  try {
    validateGroupCreationFlow();
    validateAppContextGroupOperations();
    validateHybridDataService();
    validateFirebaseDataService();
    validateGroupDetailsScreen();
    validateAddExpenseScreen();
    validateSettleUpModal();
    validateDataConsistency();
    generateRecommendations();
    
    console.log('‚úÖ Group process validation completed!');
    console.log('\nüìù SUMMARY:');
    console.log('‚úÖ Validated group creation flow');
    console.log('‚úÖ Validated AppContext operations');
    console.log('‚úÖ Validated hybrid data service');
    console.log('‚úÖ Validated Firebase data service');
    console.log('‚úÖ Validated group details screen');
    console.log('‚úÖ Validated add expense screen');
    console.log('‚úÖ Validated settle up modal');
    console.log('‚úÖ Validated data consistency');
    console.log('‚úÖ Generated recommendations');
    
    console.log('\nüîß NEXT STEPS:');
    console.log('1. Address any validation failures identified above');
    console.log('2. Implement the recommendations provided');
    console.log('3. Test the complete group process end-to-end');
    console.log('4. Monitor performance and user feedback');
    
  } catch (error) {
    console.error('‚ùå Error in validation:', error);
  }
}

// Export functions for manual execution
module.exports = {
  validateGroupCreationFlow,
  validateAppContextGroupOperations,
  validateHybridDataService,
  validateFirebaseDataService,
  validateGroupDetailsScreen,
  validateAddExpenseScreen,
  validateSettleUpModal,
  validateDataConsistency,
  generateRecommendations,
  main
};

// Run if called directly
if (require.main === module) {
  main();
} 