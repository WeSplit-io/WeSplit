name: ðŸš€ WeSplit CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans weekly
    - cron: '0 2 * * 1'

env:
  NODE_VERSION: '18'
  EXPO_VERSION: 'latest'

jobs:
  # ðŸ”’ Security Scanning
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run Security Audit
        run: npm run security:audit
        continue-on-error: true

      - name: ðŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ðŸ” Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: HEAD~1

  # ðŸ§ª Testing
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: ðŸ§ª Run unit tests
        run: npm test
        continue-on-error: true

      - name: ðŸ§ª Run integration tests
        run: npm run test:integration
        continue-on-error: true

      - name: ðŸ“Š Generate coverage report
        run: npm run test:coverage
        continue-on-error: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # ðŸ—ï¸ Build
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Setup Expo CLI
        run: npm install -g @expo/cli

      - name: ðŸ” Setup environment variables
        run: |
          echo "EXPO_PUBLIC_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "EXPO_PUBLIC_FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}" >> .env

      - name: ðŸ—ï¸ Build for Android
        run: eas build --platform android --non-interactive

      - name: ðŸ—ï¸ Build for iOS
        run: eas build --platform ios --non-interactive

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            *.apk
            *.aab
            *.ipa

  # ðŸ” Quality Assurance
  quality-check:
    name: ðŸ” Quality Check
    runs-on: ubuntu-latest
    needs: [security-scan, test, build]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run TypeScript check
        run: npx tsc --noEmit

      - name: ðŸ” Run dependency check
        run: npm audit --audit-level=high

      - name: ðŸ” Check bundle size
        run: npm run analyze
        continue-on-error: true

      - name: ðŸ” Run performance tests
        run: npm run test:performance
        continue-on-error: true

  # ðŸš€ Deploy (Only on main branch)
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-scan, test, build, quality-check]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Setup Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: ðŸš€ Deploy to Firebase
        run: firebase deploy --only hosting,functions

      - name: ðŸ” Verify deployment
        run: npm run verify:deployment

      - name: ðŸ“§ Send deployment notification
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'ðŸš€ WeSplit deployed successfully to production!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ðŸ“Š Performance Monitoring
  performance:
    name: ðŸ“Š Performance Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“Š Run Lighthouse CI
        run: npm run lighthouse:ci
        continue-on-error: true

      - name: ðŸ“Š Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: .lighthouseci/

  # ðŸ”’ Security Compliance Check
  compliance:
    name: ðŸ”’ Compliance Check
    runs-on: ubuntu-latest
    needs: [security-scan, test]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check for hardcoded secrets
        run: |
          if grep -r "AIzaSy\|sk_\|pk_" src/; then
            echo "âŒ Hardcoded secrets found!"
            exit 1
          fi

      - name: ðŸ” Check environment variables
        run: |
          if ! grep -q "EXPO_PUBLIC_FIREBASE_API_KEY" .env.example; then
            echo "âŒ Missing environment variable template!"
            exit 1
          fi

      - name: ðŸ” Check security documentation
        run: |
          if [ ! -f "SECURITY.md" ]; then
            echo "âŒ Security documentation missing!"
            exit 1
          fi

      - name: âœ… Compliance check passed
        run: echo "âœ… All compliance checks passed!"

  # ðŸ“‹ Summary
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [security-scan, test, build, quality-check, deploy, performance, compliance]
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸš€ WeSplit CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Completed Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Quality Check: ${{ needs.quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Performance: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Compliance: ${{ needs.compliance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor deployment health" >> $GITHUB_STEP_SUMMARY
          echo "- Review security scan results" >> $GITHUB_STEP_SUMMARY
          echo "- Check performance metrics" >> $GITHUB_STEP_SUMMARY 